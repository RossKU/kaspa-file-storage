<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaspa File Format v2 - Real Network Implementation</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        .header {
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        h1 {
            margin: 0;
            color: #e94560;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .container {
            background: #0f3460;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .version-box {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e94560;
        }
        .version-box h3 {
            color: #e94560;
            margin-top: 0;
        }
        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }
        button:hover {
            background: #c13651;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(233, 69, 96, 0.3);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        textarea {
            width: 100%;
            background: #16213e;
            color: #eee;
            border: 1px solid #e94560;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Consolas', monospace;
            resize: vertical;
        }
        input[type="file"] {
            display: none;
        }
        .file-input-label {
            display: inline-block;
            background: #16213e;
            color: #e94560;
            border: 2px dashed #e94560;
            padding: 20px;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            width: 100%;
            box-sizing: border-box;
        }
        .file-input-label:hover {
            background: #1a2540;
            border-color: #ff5c7c;
        }
        .metric-box {
            background: rgba(233, 69, 96, 0.1);
            border: 1px solid #e94560;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { color: #4CAF50; }
        .error { color: #ff5252; }
        .warning { color: #ffc107; }
        .info { color: #2196F3; }
        .feature-list {
            list-style: none;
            padding: 0;
        }
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .feature-list li:before {
            content: "âœ“ ";
            color: #4CAF50;
            font-weight: bold;
        }
        .test-result {
            background: #16213e;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #e94560;
        }
        .json-view {
            background: #0a0a0a;
            color: #4CAF50;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        .migration-flow {
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            margin: 20px 0;
        }
        .flow-item {
            text-align: center;
            padding: 20px;
        }
        .flow-arrow {
            font-size: 30px;
            color: #e94560;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #16213e;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #e94560, #ff5c7c);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-online { background: #4CAF50; }
        .status-offline { background: #ff5252; }
        .status-connecting { background: #ffc107; animation: pulse 1s infinite; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .log-container {
            background: #0a0a0a;
            color: #0f0;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            border-radius: 5px;
            margin: 10px 0;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-time {
            color: #888;
        }
        .log-error {
            color: #ff5252;
        }
        .log-success {
            color: #4CAF50;
        }
        .log-info {
            color: #2196F3;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ .kaspa File Format v2.0 - Real Network Implementation</h1>
        <p>å®Ÿéš›ã®WebSocket/Explorer APIæ¥ç¶šã«ã‚ˆã‚‹æœ¬ç•ªç’°å¢ƒå¯¾å¿œç‰ˆ</p>
        <div id="networkStatus" style="margin-top: 10px;">
            <span class="status-indicator status-offline"></span>
            <span id="statusText">æœªæ¥ç¶š</span>
        </div>
    </div>

    <!-- WASM Initialization -->
    <div class="container">
        <h2>ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–</h2>
        <button onclick="initializeWASM()">WASM SDKã‚’åˆæœŸåŒ–</button>
        <button onclick="connectToNetwork()" id="connectBtn" disabled>ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶š</button>
        <div id="initStatus" class="metric-box" style="display: none;"></div>
        <div class="log-container" id="systemLog"></div>
    </div>

    <!-- Format Comparison -->
    <div class="container">
        <h2>ğŸ“Š ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¯”è¼ƒ</h2>
        
        <div class="comparison-grid">
            <div class="version-box">
                <h3>v1.0 (ç¾è¡Œ)</h3>
                <ul class="feature-list">
                    <li>åŸºæœ¬çš„ãªãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±</li>
                    <li>TxIDãƒ™ãƒ¼ã‚¹ã®å‚ç…§</li>
                    <li>ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ </li>
                    <li>WebSocketéå¯¾å¿œ</li>
                </ul>
                <textarea id="v1Format" rows="15">{
  "version": "1.0",
  "created": "2025-01-01T00:00:00Z",
  "network": "testnet-10",
  "file": {
    "name": "example.pdf",
    "size": 12345,
    "checksum": "sha256:abc123...",
    "txId": "19fb27542f4fc27274cc928b68ce1630f23a4753c9e71db0ff3e3e5ebbc655e5",
    "chunks": []
  }
}</textarea>
            </div>
            
            <div class="version-box">
                <h3>v2.0 (æ–°è¦)</h3>
                <ul class="feature-list">
                    <li>BlockIDæƒ…å ±ã®è¿½åŠ </li>
                    <li>Explorer API URL</li>
                    <li>å›å¾©æƒ…å ±ã®å……å®Ÿ</li>
                    <li>WebSocketç›£è¦–ãƒ‡ãƒ¼ã‚¿</li>
                    <li>ãƒãƒ«ãƒã‚½ãƒ¼ã‚¹å¯¾å¿œ</li>
                </ul>
                <textarea id="v2Format" rows="20">{
  "version": "2.0",
  "created": "2025-07-03T00:00:00Z",
  "network": "testnet-10",
  "metadata": {
    "txId": "19fb27542f4fc27274cc928b68ce1630f23a4753c9e71db0ff3e3e5ebbc655e5",
    "blockId": "95a5e4101246828842097738c9e09c1814c155c966ddcbb6485c01f819d32460",
    "blockHeight": 190866386,
    "confirmations": 10,
    "explorerUrl": "https://explorer-tn10.kaspa.org/txs/19fb27542f4fc27274cc928b68ce1630f23a4753c9e71db0ff3e3e5ebbc655e5"
  },
  "file": {
    "name": "example.pdf",
    "size": 12345,
    "mimeType": "application/pdf",
    "checksum": "sha256:abc123...",
    "encrypted": true,
    "chunks": []
  },
  "recovery": {
    "explorerApi": true,
    "wsMonitorData": {
      "foundAt": 1751511058796,
      "blockTime": 1751511037513,
      "method": "websocket"
    }
  }
}</textarea>
            </div>
        </div>
    </div>

    <!-- Real Network Operations -->
    <div class="container">
        <h2>ğŸŒ ãƒªã‚¢ãƒ«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ“ä½œ</h2>
        
        <div class="test-section">
            <h3>1. TxIDã‹ã‚‰BlockIDå–å¾—ï¼ˆå®Ÿéš›ã®APIä½¿ç”¨ï¼‰</h3>
            <input type="text" id="txIdInput" placeholder="TxIDã‚’å…¥åŠ›ï¼ˆä¾‹: 19fb27542f4fc27274cc928b68ce1630f23a4753c9e71db0ff3e3e5ebbc655e5ï¼‰" style="width: 100%; padding: 10px; margin: 10px 0;">
            <button onclick="fetchBlockIdFromTxId()">Explorer APIã§å–å¾—</button>
            <button onclick="monitorWithWebSocket()">WebSocketã§ç›£è¦–</button>
            <div id="blockIdResult"></div>
        </div>
        
        <div class="test-section">
            <h3>2. BlockIDã‹ã‚‰ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å–å¾—ï¼ˆRPCä½¿ç”¨ï¼‰</h3>
            <input type="text" id="blockIdInput" placeholder="BlockIDã‚’å…¥åŠ›" style="width: 100%; padding: 10px; margin: 10px 0;">
            <button onclick="fetchPayloadFromBlockId()">ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰å–å¾—</button>
            <div id="payloadResult"></div>
        </div>
    </div>

    <!-- Migration Tool -->
    <div class="container">
        <h2>ğŸ”„ å®Ÿãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
        
        <div class="migration-flow">
            <div class="flow-item">
                <label for="v1FileInput" class="file-input-label">
                    ğŸ“ v1.0 .kaspaãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                    <br><small>ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ</small>
                </label>
                <input type="file" id="v1FileInput" accept=".kaspa" onchange="loadV1File(event)">
            </div>
            <div class="flow-arrow">â†’</div>
            <div class="flow-item">
                <button onclick="migrateToV2Real()" id="migrateBtn" disabled>
                    ğŸ”„ å®ŸAPIã§v2.0ã«å¤‰æ›
                </button>
            </div>
            <div class="flow-arrow">â†’</div>
            <div class="flow-item">
                <button onclick="downloadV2()" id="downloadBtn" disabled>
                    ğŸ’¾ v2.0ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </div>
        
        <div id="migrationResult"></div>
    </div>

    <!-- Real-time WebSocket Monitor -->
    <div class="container">
        <h2>ğŸ“¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ WebSocketç›£è¦–</h2>
        <button onclick="startWebSocketMonitor()">ç›£è¦–é–‹å§‹</button>
        <button onclick="stopWebSocketMonitor()">ç›£è¦–åœæ­¢</button>
        <div class="metric-box">
            <p>ç›£è¦–ä¸­ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³: <span id="monitorCount">0</span></p>
            <p>æ¤œå‡ºã•ã‚ŒãŸBlockID: <span id="detectedCount">0</span></p>
        </div>
        <div class="log-container" id="wsLog"></div>
    </div>

    <!-- Real Use Case Tests -->
    <div class="container">
        <h2>ğŸ§ª å®Ÿç’°å¢ƒãƒ†ã‚¹ãƒˆ</h2>
        
        <div class="test-section">
            <h3>çµ±åˆãƒ†ã‚¹ãƒˆ</h3>
            <button onclick="runRealScenarios()">å®Ÿç’°å¢ƒã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œ</button>
            <div id="scenarioResults"></div>
        </div>
    </div>

    <script type="module">
        // Global state
        let kaspa = null;
        let rpcClient = null;
        let currentV1Data = null;
        let currentV2Data = null;
        let wsMonitorActive = false;
        let monitoredTransactions = new Map();
        
        // Logging utility
        function log(message, type = 'info') {
            const logContainer = document.getElementById('systemLog');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function wsLog(message, type = 'info') {
            const logContainer = document.getElementById('wsLog');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Network status
        function updateNetworkStatus(status, text) {
            const indicator = document.querySelector('.status-indicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = 'status-indicator';
            switch(status) {
                case 'online':
                    indicator.classList.add('status-online');
                    break;
                case 'offline':
                    indicator.classList.add('status-offline');
                    break;
                case 'connecting':
                    indicator.classList.add('status-connecting');
                    break;
            }
            statusText.textContent = text;
        }

        // WASM initialization
        window.initializeWASM = async function() {
            try {
                log('WASM SDKåˆæœŸåŒ–ã‚’é–‹å§‹...');
                updateNetworkStatus('connecting', 'WASMåˆæœŸåŒ–ä¸­...');
                
                // Import WASM SDK
                kaspa = await import('./kaspa-core.js');
                log('kaspa-core.jsã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');
                
                // Initialize WASM binary - CRITICAL!
                await kaspa.default('./kaspa-core_bg.wasm');
                log('WASMãƒã‚¤ãƒŠãƒªã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ');
                
                // Verify functions exist
                const requiredFunctions = ['RpcClient', 'Resolver', 'createTransactions', 'addressFromScriptPublicKey'];
                for (const func of requiredFunctions) {
                    if (typeof kaspa[func] !== 'function') {
                        throw new Error(`å¿…è¦ãªé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${func}`);
                    }
                }
                log('ã™ã¹ã¦ã®å¿…è¦ãªé–¢æ•°ã‚’ç¢ºèªã—ã¾ã—ãŸ', 'success');
                
                // Global assignment for stability
                window.kaspa = kaspa;
                
                document.getElementById('initStatus').style.display = 'block';
                document.getElementById('initStatus').innerHTML = '<p class="success">âœ… WASM SDKåˆæœŸåŒ–å®Œäº†</p>';
                document.getElementById('connectBtn').disabled = false;
                
                updateNetworkStatus('offline', 'WASMæº–å‚™å®Œäº†');
                log('WASM SDKåˆæœŸåŒ–å®Œäº†!', 'success');
                
            } catch (error) {
                log(`WASMåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                document.getElementById('initStatus').style.display = 'block';
                document.getElementById('initStatus').innerHTML = `<p class="error">âŒ åˆæœŸåŒ–å¤±æ•—: ${error.message}</p>`;
                updateNetworkStatus('offline', 'WASMåˆæœŸåŒ–å¤±æ•—');
            }
        };

        // Network connection
        window.connectToNetwork = async function() {
            try {
                log('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’é–‹å§‹...');
                updateNetworkStatus('connecting', 'æ¥ç¶šä¸­...');
                
                // Create RPC client with resolver
                rpcClient = new kaspa.RpcClient({
                    resolver: new kaspa.Resolver(),
                    networkId: 'testnet-10'
                });
                
                log('RPCæ¥ç¶šã‚’è©¦è¡Œä¸­...');
                await rpcClient.connect();
                
                // Test connection
                const info = await rpcClient.getServerInfo();
                log(`æ¥ç¶šæˆåŠŸ! ã‚µãƒ¼ãƒãƒ¼: ${info.serverVersion}`, 'success');
                log(`ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯: ${info.networkId}`, 'info');
                
                updateNetworkStatus('online', 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šæ¸ˆã¿');
                
            } catch (error) {
                log(`æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateNetworkStatus('offline', 'æ¥ç¶šå¤±æ•—');
            }
        };

        // Fetch BlockID from TxID using Explorer API
        window.fetchBlockIdFromTxId = async function() {
            const txId = document.getElementById('txIdInput').value.trim();
            if (!txId) {
                alert('TxIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            const resultDiv = document.getElementById('blockIdResult');
            resultDiv.innerHTML = '<p>Explorer APIã§æ¤œç´¢ä¸­...</p>';
            
            try {
                log(`Explorer APIã§TxIDæ¤œç´¢: ${txId}`);
                
                // Testnet-10 Explorer API
                const apiUrl = `https://api-tn10.kaspa.org/transactions/${txId}`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                const blockId = data.block_hash?.[0] || data.accepting_block_hash || null;
                
                if (blockId) {
                    log(`BlockIDå–å¾—æˆåŠŸ: ${blockId}`, 'success');
                    resultDiv.innerHTML = `
                        <div class="metric-box">
                            <h4 class="success">âœ… BlockIDå–å¾—æˆåŠŸ</h4>
                            <p><strong>TxID:</strong> ${txId}</p>
                            <p><strong>BlockID:</strong> ${blockId}</p>
                            <p><strong>Block Time:</strong> ${new Date(data.block_time).toLocaleString()}</p>
                            <p><strong>Confirmations:</strong> ${data.confirmations || 'N/A'}</p>
                            <button onclick="document.getElementById('blockIdInput').value='${blockId}'">
                                BlockIDå…¥åŠ›æ¬„ã«ã‚³ãƒ”ãƒ¼
                            </button>
                        </div>
                    `;
                } else {
                    throw new Error('BlockIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
            } catch (error) {
                log(`Explorer APIã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                resultDiv.innerHTML = `
                    <div class="metric-box">
                        <p class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                    </div>
                `;
            }
        };

        // Fetch payload from BlockID using RPC
        window.fetchPayloadFromBlockId = async function() {
            const blockId = document.getElementById('blockIdInput').value.trim();
            if (!blockId) {
                alert('BlockIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!rpcClient) {
                alert('å…ˆã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã—ã¦ãã ã•ã„');
                return;
            }
            
            const resultDiv = document.getElementById('payloadResult');
            resultDiv.innerHTML = '<p>ãƒ–ãƒ­ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</p>';
            
            try {
                log(`RPCçµŒç”±ã§ãƒ–ãƒ­ãƒƒã‚¯å–å¾—: ${blockId}`);
                
                // Get block with transactions
                const request = { hash: blockId, includeTransactions: true };
                const response = await rpcClient.getBlock(request);
                const block = response.block?.block || response.block;
                
                if (!block) {
                    throw new Error('ãƒ–ãƒ­ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                log(`ãƒ–ãƒ­ãƒƒã‚¯å–å¾—æˆåŠŸã€‚ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ•°: ${block.transactions?.length || 0}`, 'success');
                
                // Find transactions with payloads
                const txWithPayloads = [];
                for (const tx of block.transactions || []) {
                    if (tx.payload && tx.payload !== '') {
                        const payloadHex = tx.payload;
                        const payloadBytes = hexToBytes(payloadHex);
                        const payloadText = new TextDecoder().decode(payloadBytes);
                        
                        txWithPayloads.push({
                            id: tx.verboseData?.transactionId || 'Unknown',
                            payloadSize: payloadBytes.length,
                            payloadHex: payloadHex.substring(0, 100) + '...',
                            payloadText: payloadText.substring(0, 100) + '...'
                        });
                    }
                }
                
                resultDiv.innerHTML = `
                    <div class="metric-box">
                        <h4 class="success">âœ… ãƒ–ãƒ­ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ</h4>
                        <p><strong>BlockID:</strong> ${blockId}</p>
                        <p><strong>ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æ•°:</strong> ${block.transactions?.length || 0}</p>
                        <p><strong>ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä»˜ãTx:</strong> ${txWithPayloads.length}</p>
                        ${txWithPayloads.map(tx => `
                            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                                <p><strong>TxID:</strong> ${tx.id}</p>
                                <p><strong>ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ã‚º:</strong> ${tx.payloadSize} bytes</p>
                                <p><strong>Hex:</strong> <code>${tx.payloadHex}</code></p>
                                <p><strong>Text:</strong> ${tx.payloadText}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
                
            } catch (error) {
                log(`RPCã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                resultDiv.innerHTML = `
                    <div class="metric-box">
                        <p class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                    </div>
                `;
            }
        };

        // WebSocket monitoring
        window.startWebSocketMonitor = async function() {
            if (!rpcClient) {
                alert('å…ˆã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã—ã¦ãã ã•ã„');
                return;
            }
            
            if (wsMonitorActive) {
                wsLog('ã™ã§ã«ç›£è¦–ä¸­ã§ã™', 'warning');
                return;
            }
            
            try {
                wsLog('WebSocketç›£è¦–ã‚’é–‹å§‹...');
                wsMonitorActive = true;
                
                // Subscribe to block added events
                await rpcClient.subscribeBlockAdded();
                wsLog('Block Addedã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­ã—ã¾ã—ãŸ', 'success');
                
                // Event listener
                rpcClient.addEventListener('block-added', (event) => {
                    const block = event.data.block;
                    const blockId = block.header.hash;
                    const blockTime = new Date(Number(block.header.timestamp));
                    
                    wsLog(`æ–°ã—ã„ãƒ–ãƒ­ãƒƒã‚¯: ${blockId} (${blockTime.toLocaleTimeString()})`);
                    
                    // Check transactions
                    if (block.transactions && block.transactions.length > 0) {
                        for (const tx of block.transactions) {
                            const txId = tx.verboseData?.transactionId;
                            if (txId) {
                                monitoredTransactions.set(txId, {
                                    blockId: blockId,
                                    blockTime: blockTime,
                                    foundAt: new Date()
                                });
                                
                                if (tx.payload && tx.payload !== '') {
                                    wsLog(`ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ä»˜ãTxæ¤œå‡º: ${txId}`, 'success');
                                }
                            }
                        }
                        
                        document.getElementById('monitorCount').textContent = monitoredTransactions.size;
                        document.getElementById('detectedCount').textContent = monitoredTransactions.size;
                    }
                });
                
                wsLog('ç›£è¦–ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
                
            } catch (error) {
                wsLog(`ç›£è¦–é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                wsMonitorActive = false;
            }
        };

        window.stopWebSocketMonitor = async function() {
            if (!wsMonitorActive) {
                wsLog('ç›£è¦–ã¯é–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                return;
            }
            
            try {
                if (rpcClient) {
                    await rpcClient.unsubscribeBlockAdded();
                    wsLog('ç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸ', 'success');
                }
                wsMonitorActive = false;
                
            } catch (error) {
                wsLog(`ç›£è¦–åœæ­¢ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        };

        // File handling
        window.loadV1File = function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    currentV1Data = JSON.parse(e.target.result);
                    document.getElementById('v1Format').value = JSON.stringify(currentV1Data, null, 2);
                    document.getElementById('migrateBtn').disabled = false;
                    
                    document.getElementById('migrationResult').innerHTML = `
                        <div class="metric-box">
                            <p class="success">âœ… v1.0ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ</p>
                            <p>ãƒ•ã‚¡ã‚¤ãƒ«å: ${currentV1Data.file?.name || 'Unknown'}</p>
                            <p>ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${currentV1Data.version}</p>
                        </div>
                    `;
                } catch (error) {
                    document.getElementById('migrationResult').innerHTML = `
                        <div class="metric-box">
                            <p class="error">âŒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                        </div>
                    `;
                }
            };
            reader.readAsText(file);
        };

        // Real migration with actual API calls
        window.migrateToV2Real = async function() {
            if (!currentV1Data) {
                alert('v1ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                return;
            }
            
            const result = document.getElementById('migrationResult');
            result.innerHTML = '<div class="progress-bar"><div class="progress-fill" style="width: 0%">0%</div></div>';
            
            try {
                await updateProgress(20, 'TxIDæ¤œè¨¼ä¸­...');
                const txId = currentV1Data.file?.txId;
                
                if (!txId) {
                    throw new Error('v1ãƒ•ã‚¡ã‚¤ãƒ«ã«TxIDãŒã‚ã‚Šã¾ã›ã‚“');
                }
                
                await updateProgress(40, 'Explorer APIã§BlockIDå–å¾—ä¸­...');
                
                // Real API call
                const apiUrl = `https://api-tn10.kaspa.org/transactions/${txId}`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                const blockId = data.block_hash?.[0] || data.accepting_block_hash || null;
                
                if (!blockId) {
                    throw new Error('BlockIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                await updateProgress(60, 'ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆä¸­...');
                
                // Create v2 format with real data
                currentV2Data = {
                    version: "2.0",
                    created: new Date().toISOString(),
                    network: currentV1Data.network || "testnet-10",
                    metadata: {
                        txId: txId,
                        blockId: blockId,
                        blockHeight: data.block_height || null,
                        confirmations: data.confirmations || null,
                        explorerUrl: `https://explorer-tn10.kaspa.org/txs/${txId}`
                    },
                    file: {
                        name: currentV1Data.file?.name || "unknown.dat",
                        size: currentV1Data.file?.size || 0,
                        mimeType: getMimeType(currentV1Data.file?.name),
                        checksum: currentV1Data.file?.checksum || "sha256:unknown",
                        encrypted: currentV1Data.encrypted !== undefined ? currentV1Data.encrypted : true,
                        chunks: currentV1Data.file?.chunks || []
                    },
                    recovery: {
                        explorerApi: true,
                        wsMonitorData: monitoredTransactions.has(txId) ? {
                            foundAt: monitoredTransactions.get(txId).foundAt.getTime(),
                            blockTime: monitoredTransactions.get(txId).blockTime.getTime(),
                            method: "websocket"
                        } : null,
                        backupSources: [
                            "https://api-tn10.kaspa.org",
                            "https://explorer-tn10.kaspa.org"
                        ]
                    }
                };
                
                await updateProgress(80, 'ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›ä¸­...');
                document.getElementById('v2Format').value = JSON.stringify(currentV2Data, null, 2);
                
                await updateProgress(100, 'å®Œäº†ï¼');
                
                result.innerHTML = `
                    <div class="metric-box">
                        <h3 class="success">âœ… å®ŸAPIã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ</h3>
                        <table>
                            <tr><th>é …ç›®</th><th>v1.0</th><th>v2.0</th></tr>
                            <tr>
                                <td>ãƒãƒ¼ã‚¸ãƒ§ãƒ³</td>
                                <td>${currentV1Data.version}</td>
                                <td>${currentV2Data.version}</td>
                            </tr>
                            <tr>
                                <td>BlockID</td>
                                <td class="error">ãªã—</td>
                                <td class="success">${currentV2Data.metadata.blockId.substring(0, 16)}...</td>
                            </tr>
                            <tr>
                                <td>Block Height</td>
                                <td class="error">ãªã—</td>
                                <td class="success">${currentV2Data.metadata.blockHeight || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td>ç¢ºèªæ•°</td>
                                <td class="error">ãªã—</td>
                                <td class="success">${currentV2Data.metadata.confirmations || 'N/A'}</td>
                            </tr>
                        </table>
                    </div>
                `;
                
                document.getElementById('downloadBtn').disabled = false;
                log('ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†', 'success');
                
            } catch (error) {
                log(`ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                result.innerHTML = `
                    <div class="metric-box">
                        <p class="error">âŒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—: ${error.message}</p>
                    </div>
                `;
            }
        };

        // Real scenario tests
        window.runRealScenarios = async function() {
            const result = document.getElementById('scenarioResults');
            result.innerHTML = '<p>å®Ÿç’°å¢ƒã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</p>';
            
            const scenarios = [];
            
            // Scenario 1: Explorer API test
            try {
                log('ã‚·ãƒŠãƒªã‚ª1: Explorer APIãƒ†ã‚¹ãƒˆé–‹å§‹');
                const testTxId = '19fb27542f4fc27274cc928b68ce1630f23a4753c9e71db0ff3e3e5ebbc655e5';
                const apiUrl = `https://api-tn10.kaspa.org/transactions/${testTxId}`;
                const response = await fetch(apiUrl);
                
                scenarios.push({
                    name: "Explorer APIæ¥ç¶š",
                    steps: [
                        "APIæ¥ç¶šç¢ºèª",
                        "TxIDã‹ã‚‰BlockIDå–å¾—",
                        "ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿å–å¾—"
                    ],
                    result: response.ok ? "success" : "error",
                    details: response.ok ? "APIæ­£å¸¸å‹•ä½œ" : `Status: ${response.status}`
                });
            } catch (error) {
                scenarios.push({
                    name: "Explorer APIæ¥ç¶š",
                    steps: ["APIæ¥ç¶šç¢ºèª"],
                    result: "error",
                    details: error.message
                });
            }
            
            // Scenario 2: RPC connection test
            if (rpcClient) {
                try {
                    log('ã‚·ãƒŠãƒªã‚ª2: RPCæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹');
                    const info = await rpcClient.getServerInfo();
                    scenarios.push({
                        name: "RPCæ¥ç¶š",
                        steps: [
                            "RPCæ¥ç¶šç¢ºèª",
                            "ã‚µãƒ¼ãƒãƒ¼æƒ…å ±å–å¾—",
                            "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèª"
                        ],
                        result: "success",
                        details: `Server: ${info.serverVersion}`
                    });
                } catch (error) {
                    scenarios.push({
                        name: "RPCæ¥ç¶š",
                        steps: ["RPCæ¥ç¶šç¢ºèª"],
                        result: "error",
                        details: error.message
                    });
                }
            } else {
                scenarios.push({
                    name: "RPCæ¥ç¶š",
                    steps: ["RPCæ¥ç¶šç¢ºèª"],
                    result: "error",
                    details: "æœªæ¥ç¶š"
                });
            }
            
            // Display results
            let html = '<div class="test-result"><h4>å®Ÿç’°å¢ƒã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆçµæœ</h4>';
            
            for (const scenario of scenarios) {
                html += `
                    <div class="metric-box">
                        <h5>${scenario.result === 'success' ? 'âœ…' : 'âŒ'} ${scenario.name}</h5>
                        <ol>
                            ${scenario.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                        <p class="${scenario.result}">${scenario.result === 'success' ? 'æˆåŠŸ' : 'å¤±æ•—'}</p>
                        <p class="info">è©³ç´°: ${scenario.details}</p>
                    </div>
                `;
            }
            
            const successCount = scenarios.filter(s => s.result === 'success').length;
            html += `
                <div class="metric-box">
                    <h4>ç·åˆè©•ä¾¡</h4>
                    <p class="${successCount === scenarios.length ? 'success' : 'warning'}">
                        ${successCount}/${scenarios.length} ã‚·ãƒŠãƒªã‚ªãŒæˆåŠŸ
                    </p>
                    <p>å®Ÿç’°å¢ƒã§ã®å‹•ä½œã‚’ç¢ºèªã—ã¾ã—ãŸ</p>
                </div>
            `;
            
            result.innerHTML = html + '</div>';
        };

        // Utility functions
        async function updateProgress(percent, message) {
            const bar = document.querySelector('.progress-fill');
            if (bar) {
                bar.style.width = percent + '%';
                bar.textContent = message || percent + '%';
            }
            await new Promise(resolve => setTimeout(resolve, 300));
        }

        function getMimeType(filename) {
            if (!filename) return 'application/octet-stream';
            const ext = filename.split('.').pop().toLowerCase();
            const mimeTypes = {
                'pdf': 'application/pdf',
                'jpg': 'image/jpeg',
                'jpeg': 'image/jpeg',
                'png': 'image/png',
                'txt': 'text/plain',
                'json': 'application/json',
                'zip': 'application/zip'
            };
            return mimeTypes[ext] || 'application/octet-stream';
        }

        function hexToBytes(hex) {
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) {
                bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
            }
            return bytes;
        }

        window.downloadV2 = function() {
            if (!currentV2Data) return;
            
            const blob = new Blob([JSON.stringify(currentV2Data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (currentV2Data.file?.name || 'file').replace(/\.[^/.]+$/, '') + '.v2.kaspa';
            a.click();
            URL.revokeObjectURL(url);
        };

        // Drag and drop
        const fileInput = document.querySelector('.file-input-label');
        fileInput.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileInput.style.background = '#1a2540';
        });
        fileInput.addEventListener('dragleave', () => {
            fileInput.style.background = '#16213e';
        });
        fileInput.addEventListener('drop', (e) => {
            e.preventDefault();
            fileInput.style.background = '#16213e';
            
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.kaspa')) {
                document.getElementById('v1FileInput').files = e.dataTransfer.files;
                loadV1File({ target: { files: [file] } });
            }
        });

        // Initialize
        window.addEventListener('load', () => {
            log('ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†ã€‚WASM SDKã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„ã€‚', 'info');
        });
    </script>
</body>
</html>