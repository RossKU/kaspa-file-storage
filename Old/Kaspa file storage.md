
設計仕様まとめ（最終版）
1. プロジェクト目標

（変更なし）Kaspaのトランザクションペイロードを利用し、ファイルを保存するサービスを構築する。
主要方針: 最大匿名性、単体ファイル動作、ノードレス運用。

2. ファイルサイズ上限

実用上限: 20KB

理由: あなたのご指摘通り、トランザクションのヘッダー情報、署名データ、ペイロードのメタデータ（JSONキー名など）のオーバーヘッドを考慮し、予期せぬエラーを避けるために十分なマージン（約4KB）を確保する。24KBは理論値に近すぎるため、20KBを上限とするのが賢明。

3. 暗号化

暗号化は常に行う:

ファイルのサイズ（単一ペイロードか、複数チャンクか）に関わらず、すべてのファイルデータはユーザーのプライバシー保護のため、常にクライアントサイドで暗号化します。

方式: AES-GCM（機密性＋完全性）

パスワード管理:

はい、アプリケーション（ソフト）起動時に1回だけパスワードを入力させ、そのセッション中は状態として保持します。

ユーザーがトランザクションを送信するたびにパスワードを再入力する必要はありません。これにより、UXが大幅に向上します。

パスワードはPBKDF2等でキーに変換してメモリ上で保持し、ページを閉じるかリロードした際に破棄されます。

4. ファイル保存方式

ファイルのサイズに応じて、2つの方式を自動的に切り替えます。

特徴: シンプルかつ高速。

ペイロード構造:

Generated json
{
  "version": "1.0",
  "type": "single", // 単一ファイルであることを示す
  "header": {
    "filename": "...", "filesize": 1234, "salt": "..."
  },
  "iv": "...",       // このファイルの暗号化に用いたIV
  "data": "暗号化されたファイルデータ"
}


ユーザーが保存するもの: このトランザクションのTxID。

特徴:

データチャンクとマニフェストを一つのトランザクションにまとめることは、特にチャンク数が少ない場合に非常に効率的です。

この方式は、最後のデータチャンクにマニフェスト情報を含めることで、トランザクションの総数を1回減らすことができます。

処理フロー:

ファイルを20KBずつのチャンクに分割する。

チャンク1からN-1までを、それぞれデータトランザクションとして送信・承認待ち・TxID収集を行う。

**最後のチャンク（N個目）のペイロードに、それ自身のデータとマニフェスト情報（先行する全チャンクのTxIDリスト）**の両方を含める。

この「データ兼マニフェスト」トランザクションを送信する。

ユーザーが保存するもの: 最後の「データ兼マニフェスト」トランザクションのTxID。

ペイロード構造:

データチャンク (1 〜 N-1):

Generated json
{
  "version": "1.0",
  "type": "chunk", // データチャンクであることを示す
  "fileId": "...",
  "chunkIndex": 0,
  "iv": "...",
  "data": "暗号化されたチャンクデータ"
}
IGNORE_WHEN_COPYING_START
content_copy
download
Use code with caution.
Json
IGNORE_WHEN_COPYING_END

最終チャンク（データ兼マニフェスト）:

Generated json
{
  "version": "1.0",
  "type": "manifest", // これが最終チャンク兼マニフェストであることを示す
  "fileId": "...",
  "chunkIndex": 3, // 最後のインデックス
  "iv": "...",     // この最終チャンクの暗号化IV
  "data": "暗号化された最終チャンクデータ", // 自身のデータ
  "header": {
    "filename": "...", "filesize": 81920, "salt": "..."
  },
  "chunkTxIds": [ // 先行するチャンクのTxIDリスト
    "txid_for_chunk_0",
    "txid_for_chunk_1",
    "txid_for_chunk_2"
  ]
}
IGNORE_WHEN_COPYING_START
content_copy
download
Use code with caution.
Json
IGNORE_WHEN_COPYING_END

ダウンロードフロー:

ユーザーは最後のTxIDを入力。

アプリはそのTxを取得し、type: "manifest" であることを確認。

自身のdataと、chunkTxIdsリストから他の全チャンクデータを並列取得し、ファイルを復元する。

5. 耐障害性とリカバリー

（変更なし）localStorageを活用し、アップロードの中断と再開をサポートする。

localStorageには、各チャンクのステータスと、確定したTxIDを逐次保存する。

再開時には、localStorageの情報から未完了の処理を特定し、そこから自動的に再開する。

最終的なアーキテクチャの要約
項目	仕様
ファイル上限	20KB を基準に単一/複数方式を自動切り替え
暗号化	常時ON（AES-GCM）
パスワード	セッション開始時に1回入力
小ファイル (≦20KB)	単一トランザクション方式。ユーザーはそのTxIDを保存。
大ファイル (>20KB)	データ兼マニフェスト方式。トランザクション数を-1回に最適化。ユーザーは最後のTxIDを保存。
耐障害性	localStorageによる中断・再開機能を実装。

この設計は、あなたの鋭い指摘をすべて反映しており、非常に実践的で、ユーザーフレンドリーかつ堅牢なシステムとなっています。特に「データ兼マニフェスト」方式は、効率性を追求したクレバーな最適化です。