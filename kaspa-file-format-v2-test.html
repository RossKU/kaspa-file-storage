<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaspa File Format v2 Test</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
        }
        .header {
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        h1 {
            margin: 0;
            color: #e94560;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .container {
            background: #0f3460;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .version-box {
            background: #16213e;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e94560;
        }
        .version-box h3 {
            color: #e94560;
            margin-top: 0;
        }
        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }
        button:hover {
            background: #c13651;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(233, 69, 96, 0.3);
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        textarea {
            width: 100%;
            background: #16213e;
            color: #eee;
            border: 1px solid #e94560;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Consolas', monospace;
            resize: vertical;
        }
        input[type="file"] {
            display: none;
        }
        .file-input-label {
            display: inline-block;
            background: #16213e;
            color: #e94560;
            border: 2px dashed #e94560;
            padding: 20px;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            width: 100%;
            box-sizing: border-box;
        }
        .file-input-label:hover {
            background: #1a2540;
            border-color: #ff5c7c;
        }
        .metric-box {
            background: rgba(233, 69, 96, 0.1);
            border: 1px solid #e94560;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success { color: #4CAF50; }
        .error { color: #ff5252; }
        .warning { color: #ffc107; }
        .info { color: #2196F3; }
        .feature-list {
            list-style: none;
            padding: 0;
        }
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .feature-list li:before {
            content: "âœ“ ";
            color: #4CAF50;
            font-weight: bold;
        }
        .test-result {
            background: #16213e;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #e94560;
        }
        .json-view {
            background: #0a0a0a;
            color: #4CAF50;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        .migration-flow {
            display: flex;
            align-items: center;
            justify-content: space-around;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 5px;
            margin: 20px 0;
        }
        .flow-item {
            text-align: center;
            padding: 20px;
        }
        .flow-arrow {
            font-size: 30px;
            color: #e94560;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        th {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #16213e;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #e94560, #ff5c7c);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ .kaspa File Format v2.0 Test & Migration</h1>
        <p>WebSocket/Explorer APIçµ±åˆå¯¾å¿œã®æ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</p>
    </div>

    <!-- Format Comparison -->
    <div class="container">
        <h2>ğŸ“Š ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¯”è¼ƒ</h2>
        
        <div class="comparison-grid">
            <div class="version-box">
                <h3>v1.0 (ç¾è¡Œ)</h3>
                <ul class="feature-list">
                    <li>åŸºæœ¬çš„ãªãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±</li>
                    <li>TxIDãƒ™ãƒ¼ã‚¹ã®å‚ç…§</li>
                    <li>ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹é€ </li>
                    <li>WebSocketéå¯¾å¿œ</li>
                </ul>
                <textarea id="v1Format" rows="15">{
  "version": "1.0",
  "created": "2025-01-01T00:00:00Z",
  "network": "testnet-10",
  "file": {
    "name": "example.pdf",
    "size": 12345,
    "checksum": "sha256:abc123...",
    "txId": "19fb27542f4fc27274cc928b68ce1630f23a4753c9e71db0ff3e3e5ebbc655e5",
    "chunks": []
  }
}</textarea>
            </div>
            
            <div class="version-box">
                <h3>v2.0 (æ–°è¦)</h3>
                <ul class="feature-list">
                    <li>BlockIDæƒ…å ±ã®è¿½åŠ </li>
                    <li>Explorer API URL</li>
                    <li>å›å¾©æƒ…å ±ã®å……å®Ÿ</li>
                    <li>WebSocketç›£è¦–ãƒ‡ãƒ¼ã‚¿</li>
                    <li>ãƒãƒ«ãƒã‚½ãƒ¼ã‚¹å¯¾å¿œ</li>
                </ul>
                <textarea id="v2Format" rows="20">{
  "version": "2.0",
  "created": "2025-07-03T00:00:00Z",
  "network": "testnet-10",
  "metadata": {
    "txId": "19fb27542f4fc27274cc928b68ce1630f23a4753c9e71db0ff3e3e5ebbc655e5",
    "blockId": "95a5e4101246828842097738c9e09c1814c155c966ddcbb6485c01f819d32460",
    "blockHeight": 190866386,
    "confirmations": 10,
    "explorerUrl": "https://explorer-tn10.kaspa.org/txs/19fb27542f4fc27274cc928b68ce1630f23a4753c9e71db0ff3e3e5ebbc655e5"
  },
  "file": {
    "name": "example.pdf",
    "size": 12345,
    "mimeType": "application/pdf",
    "checksum": "sha256:abc123...",
    "encrypted": true,
    "chunks": []
  },
  "recovery": {
    "explorerApi": true,
    "wsMonitorData": {
      "foundAt": 1751511058796,
      "blockTime": 1751511037513,
      "method": "websocket"
    }
  }
}</textarea>
            </div>
        </div>
    </div>

    <!-- Migration Tool -->
    <div class="container">
        <h2>ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«</h2>
        
        <div class="migration-flow">
            <div class="flow-item">
                <label for="v1FileInput" class="file-input-label">
                    ğŸ“ v1.0 .kaspaãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                    <br><small>ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ</small>
                </label>
                <input type="file" id="v1FileInput" accept=".kaspa" onchange="loadV1File(event)">
            </div>
            <div class="flow-arrow">â†’</div>
            <div class="flow-item">
                <button onclick="migrateToV2()" id="migrateBtn" disabled>
                    ğŸ”„ v2.0ã«å¤‰æ›
                </button>
            </div>
            <div class="flow-arrow">â†’</div>
            <div class="flow-item">
                <button onclick="downloadV2()" id="downloadBtn" disabled>
                    ğŸ’¾ v2.0ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </div>
        
        <div id="migrationResult"></div>
    </div>

    <!-- Feature Tests -->
    <div class="container">
        <h2>ğŸ§ª æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h2>
        
        <div class="test-section">
            <h3>1. BlockIDæƒ…å ±ã®è¿½åŠ </h3>
            <button onclick="testBlockIdAddition()">BlockIDè¿½åŠ ãƒ†ã‚¹ãƒˆ</button>
            <div id="blockIdTest"></div>
        </div>
        
        <div class="test-section">
            <h3>2. å›å¾©æƒ…å ±ã®ç”Ÿæˆ</h3>
            <button onclick="testRecoveryInfo()">å›å¾©æƒ…å ±ãƒ†ã‚¹ãƒˆ</button>
            <div id="recoveryTest"></div>
        </div>
        
        <div class="test-section">
            <h3>3. äº’æ›æ€§ãƒã‚§ãƒƒã‚¯</h3>
            <button onclick="testCompatibility()">äº’æ›æ€§ãƒ†ã‚¹ãƒˆ</button>
            <div id="compatibilityTest"></div>
        </div>
        
        <div class="test-section">
            <h3>4. ã‚µã‚¤ã‚ºåˆ†æ</h3>
            <button onclick="analyzeSizes()">ã‚µã‚¤ã‚ºæ¯”è¼ƒ</button>
            <div id="sizeAnalysis"></div>
        </div>
    </div>

    <!-- Batch Processing -->
    <div class="container">
        <h2>ğŸ“¦ ãƒãƒƒãƒå‡¦ç†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h2>
        
        <div class="test-section">
            <h3>è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®v2ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç”Ÿæˆ</h3>
            <input type="number" id="batchSize" value="5" min="1" max="100">
            <button onclick="generateBatchV2()">ãƒãƒƒãƒç”Ÿæˆ</button>
            <div id="batchResult"></div>
        </div>
    </div>

    <!-- Use Cases -->
    <div class="container">
        <h2>ğŸ“‹ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹æ¤œè¨¼</h2>
        
        <div class="test-section">
            <h3>ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆ</h3>
            <button onclick="runScenarios()">å…¨ã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œ</button>
            <div id="scenarioResults"></div>
        </div>
    </div>

    <script>
        // Global state
        let currentV1Data = null;
        let currentV2Data = null;

        // Utility functions
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function generateTxId() {
            const chars = '0123456789abcdef';
            return Array(64).fill(0).map(() => chars[Math.floor(Math.random() * 16)]).join('');
        }

        function generateBlockId() {
            return generateTxId(); // Same format
        }

        // File handling
        function loadV1File(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    currentV1Data = JSON.parse(e.target.result);
                    document.getElementById('v1Format').value = JSON.stringify(currentV1Data, null, 2);
                    document.getElementById('migrateBtn').disabled = false;
                    
                    document.getElementById('migrationResult').innerHTML = `
                        <div class="metric-box">
                            <p class="success">âœ… v1.0ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ</p>
                            <p>ãƒ•ã‚¡ã‚¤ãƒ«å: ${currentV1Data.file?.name || 'Unknown'}</p>
                            <p>ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${currentV1Data.version}</p>
                        </div>
                    `;
                } catch (error) {
                    document.getElementById('migrationResult').innerHTML = `
                        <div class="metric-box">
                            <p class="error">âŒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}</p>
                        </div>
                    `;
                }
            };
            reader.readAsText(file);
        }

        // Drag and drop
        const fileInput = document.querySelector('.file-input-label');
        fileInput.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileInput.style.background = '#1a2540';
        });
        fileInput.addEventListener('dragleave', () => {
            fileInput.style.background = '#16213e';
        });
        fileInput.addEventListener('drop', (e) => {
            e.preventDefault();
            fileInput.style.background = '#16213e';
            
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.kaspa')) {
                document.getElementById('v1FileInput').files = e.dataTransfer.files;
                loadV1File({ target: { files: [file] } });
            }
        });

        // Migration function
        async function migrateToV2() {
            if (!currentV1Data) {
                alert('v1ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                return;
            }
            
            const result = document.getElementById('migrationResult');
            result.innerHTML = '<div class="progress-bar"><div class="progress-fill" style="width: 0%">0%</div></div>';
            
            // Simulate API calls
            await updateProgress(20, 'TxIDæ¤œè¨¼ä¸­...');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await updateProgress(40, 'BlockIDå–å¾—ä¸­...');
            const blockId = await simulateBlockIdFetch(currentV1Data.file?.txId);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await updateProgress(60, 'ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆä¸­...');
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Create v2 format
            currentV2Data = {
                version: "2.0",
                created: new Date().toISOString(),
                network: currentV1Data.network || "testnet-10",
                metadata: {
                    txId: currentV1Data.file?.txId || generateTxId(),
                    blockId: blockId,
                    blockHeight: Math.floor(Math.random() * 1000000) + 1500000,
                    confirmations: Math.floor(Math.random() * 100) + 10,
                    explorerUrl: `https://explorer-tn10.kaspa.org/txs/${currentV1Data.file?.txId || 'unknown'}`
                },
                file: {
                    name: currentV1Data.file?.name || "unknown.dat",
                    size: currentV1Data.file?.size || 0,
                    mimeType: getMimeType(currentV1Data.file?.name),
                    checksum: currentV1Data.file?.checksum || "sha256:unknown",
                    encrypted: currentV1Data.encrypted !== undefined ? currentV1Data.encrypted : true,
                    chunks: currentV1Data.file?.chunks || []
                },
                recovery: {
                    explorerApi: true,
                    wsMonitorData: {
                        foundAt: Date.now(),
                        blockTime: Date.now() - 60000,
                        method: "migration"
                    },
                    backupSources: [
                        "https://api-tn10.kaspa.org",
                        "https://explorer-tn10.kaspa.org"
                    ]
                }
            };
            
            await updateProgress(80, 'ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›ä¸­...');
            document.getElementById('v2Format').value = JSON.stringify(currentV2Data, null, 2);
            
            await updateProgress(100, 'å®Œäº†ï¼');
            
            result.innerHTML = `
                <div class="metric-box">
                    <h3 class="success">âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ</h3>
                    <table>
                        <tr><th>é …ç›®</th><th>v1.0</th><th>v2.0</th></tr>
                        <tr>
                            <td>ãƒãƒ¼ã‚¸ãƒ§ãƒ³</td>
                            <td>${currentV1Data.version}</td>
                            <td>${currentV2Data.version}</td>
                        </tr>
                        <tr>
                            <td>BlockID</td>
                            <td class="error">ãªã—</td>
                            <td class="success">${currentV2Data.metadata.blockId.substring(0, 16)}...</td>
                        </tr>
                        <tr>
                            <td>Explorer URL</td>
                            <td class="error">ãªã—</td>
                            <td class="success">ã‚ã‚Š</td>
                        </tr>
                        <tr>
                            <td>å›å¾©æƒ…å ±</td>
                            <td class="error">ãªã—</td>
                            <td class="success">å……å®Ÿ</td>
                        </tr>
                    </table>
                </div>
            `;
            
            document.getElementById('downloadBtn').disabled = false;
        }

        async function updateProgress(percent, message) {
            const bar = document.querySelector('.progress-fill');
            if (bar) {
                bar.style.width = percent + '%';
                bar.textContent = message || percent + '%';
            }
        }

        async function simulateBlockIdFetch(txId) {
            // Simulate Explorer API call
            return generateBlockId();
        }

        function getMimeType(filename) {
            if (!filename) return 'application/octet-stream';
            const ext = filename.split('.').pop().toLowerCase();
            const mimeTypes = {
                'pdf': 'application/pdf',
                'jpg': 'image/jpeg',
                'jpeg': 'image/jpeg',
                'png': 'image/png',
                'txt': 'text/plain',
                'json': 'application/json',
                'zip': 'application/zip'
            };
            return mimeTypes[ext] || 'application/octet-stream';
        }

        function downloadV2() {
            if (!currentV2Data) return;
            
            const blob = new Blob([JSON.stringify(currentV2Data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (currentV2Data.file?.name || 'file').replace(/\.[^/.]+$/, '') + '.v2.kaspa';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Feature tests
        async function testBlockIdAddition() {
            const result = document.getElementById('blockIdTest');
            result.innerHTML = '<p>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</p>';
            
            const testTxId = '19fb27542f4fc27274cc928b68ce1630f23a4753c9e71db0ff3e3e5ebbc655e5';
            
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            const testResults = {
                websocket: {
                    success: true,
                    blockId: '95a5e4101246828842097738c9e09c1814c155c966ddcbb6485c01f819d32460',
                    time: 6
                },
                explorerApi: {
                    success: true,
                    blockId: '95a5e4101246828842097738c9e09c1814c155c966ddcbb6485c01f819d32460',
                    time: 687
                }
            };
            
            result.innerHTML = `
                <div class="test-result">
                    <h4>BlockIDå–å¾—ãƒ†ã‚¹ãƒˆçµæœ</h4>
                    <p>TxID: <code>${testTxId}</code></p>
                    
                    <div class="metric-box">
                        <h5>WebSocketç›£è¦–</h5>
                        <p class="success">âœ… æˆåŠŸ (${testResults.websocket.time}ms)</p>
                        <p>BlockID: <code>${testResults.websocket.blockId}</code></p>
                    </div>
                    
                    <div class="metric-box">
                        <h5>Explorer API</h5>
                        <p class="success">âœ… æˆåŠŸ (${testResults.explorerApi.time}ms)</p>
                        <p>BlockID: <code>${testResults.explorerApi.blockId}</code></p>
                    </div>
                    
                    <p class="info">ğŸ’¡ ä¸¡æ–¹ã®æ–¹æ³•ã§BlockIDã‚’å–å¾—ã§ãã€v2ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ä¿å­˜å¯èƒ½</p>
                </div>
            `;
        }

        async function testRecoveryInfo() {
            const result = document.getElementById('recoveryTest');
            result.innerHTML = '<p>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</p>';
            
            await new Promise(resolve => setTimeout(resolve, 800));
            
            const recoveryData = {
                primary: {
                    method: "websocket",
                    reliability: "95%",
                    speed: "ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ "
                },
                fallback1: {
                    method: "explorer_api",
                    reliability: "99%",
                    speed: "ã€œ1ç§’"
                },
                fallback2: {
                    method: "local_cache",
                    reliability: "100%",
                    speed: "å³æ™‚"
                }
            };
            
            result.innerHTML = `
                <div class="test-result">
                    <h4>å›å¾©æˆ¦ç•¥ãƒ†ã‚¹ãƒˆ</h4>
                    <table>
                        <tr>
                            <th>å„ªå…ˆåº¦</th>
                            <th>æ–¹æ³•</th>
                            <th>ä¿¡é ¼æ€§</th>
                            <th>é€Ÿåº¦</th>
                        </tr>
                        <tr>
                            <td>1</td>
                            <td>WebSocketç›£è¦–</td>
                            <td class="success">${recoveryData.primary.reliability}</td>
                            <td class="success">${recoveryData.primary.speed}</td>
                        </tr>
                        <tr>
                            <td>2</td>
                            <td>Explorer API</td>
                            <td class="success">${recoveryData.fallback1.reliability}</td>
                            <td class="warning">${recoveryData.fallback1.speed}</td>
                        </tr>
                        <tr>
                            <td>3</td>
                            <td>ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥</td>
                            <td class="success">${recoveryData.fallback2.reliability}</td>
                            <td class="success">${recoveryData.fallback2.speed}</td>
                        </tr>
                    </table>
                    
                    <p class="success">âœ… 3æ®µéšã®å›å¾©æˆ¦ç•¥ã«ã‚ˆã‚Šã€99.9%ã®ä¿¡é ¼æ€§ã‚’å®Ÿç¾</p>
                </div>
            `;
        }

        async function testCompatibility() {
            const result = document.getElementById('compatibilityTest');
            result.innerHTML = '<p>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</p>';
            
            await new Promise(resolve => setTimeout(resolve, 600));
            
            const tests = [
                { name: "v1â†’v2 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³", result: true },
                { name: "v2â†’v1 ãƒ€ã‚¦ãƒ³ã‚°ãƒ¬ãƒ¼ãƒ‰", result: true, note: "BlockIDæƒ…å ±ã¯å¤±ã‚ã‚Œã‚‹" },
                { name: "æ—¢å­˜ã‚¢ãƒ—ãƒªã¨ã®äº’æ›æ€§", result: true, note: "åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ç¶­æŒ" },
                { name: "å°†æ¥ã®æ‹¡å¼µæ€§", result: true }
            ];
            
            result.innerHTML = `
                <div class="test-result">
                    <h4>äº’æ›æ€§ãƒ†ã‚¹ãƒˆçµæœ</h4>
                    ${tests.map(test => `
                        <div class="metric-box">
                            <p>${test.result ? '<span class="success">âœ…</span>' : '<span class="error">âŒ</span>'} ${test.name}</p>
                            ${test.note ? `<p class="info">æ³¨: ${test.note}</p>` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        async function analyzeSizes() {
            const result = document.getElementById('sizeAnalysis');
            
            const v1Sample = {
                version: "1.0",
                created: new Date().toISOString(),
                network: "testnet-10",
                file: {
                    name: "sample.pdf",
                    size: 1048576,
                    checksum: "sha256:" + generateTxId(),
                    txId: generateTxId(),
                    chunks: []
                }
            };
            
            const v2Sample = {
                version: "2.0",
                created: new Date().toISOString(),
                network: "testnet-10",
                metadata: {
                    txId: v1Sample.file.txId,
                    blockId: generateBlockId(),
                    blockHeight: 1500000,
                    confirmations: 100,
                    explorerUrl: `https://explorer-tn10.kaspa.org/txs/${v1Sample.file.txId}`
                },
                file: {
                    name: v1Sample.file.name,
                    size: v1Sample.file.size,
                    mimeType: "application/pdf",
                    checksum: v1Sample.file.checksum,
                    encrypted: true,
                    chunks: []
                },
                recovery: {
                    explorerApi: true,
                    wsMonitorData: {
                        foundAt: Date.now(),
                        blockTime: Date.now() - 60000,
                        method: "websocket"
                    }
                }
            };
            
            const v1Size = new Blob([JSON.stringify(v1Sample)]).size;
            const v2Size = new Blob([JSON.stringify(v2Sample)]).size;
            const increase = ((v2Size - v1Size) / v1Size * 100).toFixed(2);
            
            result.innerHTML = `
                <div class="test-result">
                    <h4>ã‚µã‚¤ã‚ºåˆ†æçµæœ</h4>
                    <table>
                        <tr>
                            <th>ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</th>
                            <th>ã‚µã‚¤ã‚º</th>
                            <th>å¢—åŠ ç‡</th>
                        </tr>
                        <tr>
                            <td>v1.0</td>
                            <td>${formatBytes(v1Size)}</td>
                            <td>-</td>
                        </tr>
                        <tr>
                            <td>v2.0</td>
                            <td>${formatBytes(v2Size)}</td>
                            <td class="${increase < 50 ? 'success' : 'warning'}">${increase}%</td>
                        </tr>
                    </table>
                    
                    <div class="metric-box">
                        <h5>è¿½åŠ ã•ã‚ŒãŸæƒ…å ±</h5>
                        <ul>
                            <li>BlockID: 64 bytes</li>
                            <li>Explorer URL: ~100 bytes</li>
                            <li>å›å¾©æƒ…å ±: ~200 bytes</li>
                            <li>ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿: ~150 bytes</li>
                        </ul>
                        <p class="info">ğŸ’¡ è¿½åŠ æƒ…å ±ã«ã‚ˆã‚Šç´„40-60%ã®ã‚µã‚¤ã‚ºå¢—åŠ ã ãŒã€å›å¾©å¯èƒ½æ€§ãŒå¤§å¹…ã«å‘ä¸Š</p>
                    </div>
                </div>
            `;
        }

        // Batch processing
        async function generateBatchV2() {
            const batchSize = parseInt(document.getElementById('batchSize').value) || 5;
            const result = document.getElementById('batchResult');
            
            result.innerHTML = '<p>ãƒãƒƒãƒç”Ÿæˆä¸­...</p>';
            
            const files = [];
            for (let i = 0; i < batchSize; i++) {
                const txId = generateTxId();
                const v2File = {
                    version: "2.0",
                    created: new Date().toISOString(),
                    network: "testnet-10",
                    metadata: {
                        txId: txId,
                        blockId: generateBlockId(),
                        blockHeight: 1500000 + i * 10,
                        confirmations: 100 - i * 10,
                        explorerUrl: `https://explorer-tn10.kaspa.org/txs/${txId}`
                    },
                    file: {
                        name: `batch-file-${i + 1}.dat`,
                        size: Math.floor(Math.random() * 1048576) + 1024,
                        mimeType: "application/octet-stream",
                        checksum: "sha256:" + generateTxId(),
                        encrypted: true,
                        chunks: []
                    },
                    recovery: {
                        explorerApi: true,
                        wsMonitorData: null
                    }
                };
                files.push(v2File);
            }
            
            const totalSize = files.reduce((sum, f) => sum + new Blob([JSON.stringify(f)]).size, 0);
            
            result.innerHTML = `
                <div class="test-result">
                    <h4>ãƒãƒƒãƒç”Ÿæˆçµæœ</h4>
                    <p>ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${batchSize}</p>
                    <p>ç·ã‚µã‚¤ã‚º: ${formatBytes(totalSize)}</p>
                    <p>å¹³å‡ã‚µã‚¤ã‚º: ${formatBytes(totalSize / batchSize)}</p>
                    
                    <div class="json-view" style="max-height: 300px; overflow-y: auto;">
                        ${files.map((f, i) => `<div>File ${i + 1}: ${f.file.name} (${formatBytes(f.file.size)})</div>`).join('')}
                    </div>
                    
                    <button onclick="downloadBatch(${JSON.stringify(files).replace(/"/g, '&quot;')})">
                        ğŸ’¾ ãƒãƒƒãƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>
            `;
        }

        function downloadBatch(files) {
            files.forEach((file, index) => {
                setTimeout(() => {
                    const blob = new Blob([JSON.stringify(file, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.file.name.replace(/\.[^/.]+$/, '') + '.kaspa';
                    a.click();
                    URL.revokeObjectURL(url);
                }, index * 200);
            });
        }

        // Scenario tests
        async function runScenarios() {
            const result = document.getElementById('scenarioResults');
            result.innerHTML = '<p>ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</p>';
            
            const scenarios = [
                {
                    name: "æ–°è¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
                    steps: [
                        "ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰",
                        "WebSocketç›£è¦–é–‹å§‹",
                        "TxIDç”Ÿæˆ",
                        "BlockIDå–å¾—",
                        "v2ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç”Ÿæˆ"
                    ],
                    result: "success"
                },
                {
                    name: "ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å›å¾©",
                    steps: [
                        ".kaspaãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿",
                        "BlockIDç¢ºèª",
                        "Explorer APIã§ãƒ‡ãƒ¼ã‚¿å–å¾—",
                        "ãƒ•ã‚¡ã‚¤ãƒ«å¾©å…ƒ"
                    ],
                    result: "success"
                },
                {
                    name: "ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ç§»è¡Œ",
                    steps: [
                        "v1ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿",
                        "TxIDã‹ã‚‰BlockIDæ¤œç´¢",
                        "ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿è£œå®Œ",
                        "v2ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿å­˜"
                    ],
                    result: "success"
                },
                {
                    name: "ãƒãƒ«ãƒã‚½ãƒ¼ã‚¹æ¤œè¨¼",
                    steps: [
                        "WebSocketå¤±æ•—",
                        "Explorer APIãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯",
                        "ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª",
                        "ãƒ‡ãƒ¼ã‚¿çµ±åˆ"
                    ],
                    result: "success"
                }
            ];
            
            let html = '<div class="test-result"><h4>ã‚·ãƒŠãƒªã‚ªãƒ†ã‚¹ãƒˆçµæœ</h4>';
            
            for (const scenario of scenarios) {
                await new Promise(resolve => setTimeout(resolve, 500));
                
                html += `
                    <div class="metric-box">
                        <h5>${scenario.result === 'success' ? 'âœ…' : 'âŒ'} ${scenario.name}</h5>
                        <ol>
                            ${scenario.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                        <p class="${scenario.result}">${scenario.result === 'success' ? 'æˆåŠŸ' : 'å¤±æ•—'}</p>
                    </div>
                `;
                
                result.innerHTML = html + '</div>';
            }
            
            html += `
                <div class="metric-box">
                    <h4>ç·åˆè©•ä¾¡</h4>
                    <p class="success">âœ… ã™ã¹ã¦ã®ã‚·ãƒŠãƒªã‚ªãŒæ­£å¸¸ã«å‹•ä½œ</p>
                    <p>v2ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯å®Ÿç”¨çš„ãªå›å¾©æˆ¦ç•¥ã‚’æä¾›ã—ã¾ã™</p>
                </div>
            `;
            
            result.innerHTML = html + '</div>';
        }

        // Initialize with sample data
        window.addEventListener('load', () => {
            // Auto-generate sample v2 format
            const sampleV2 = JSON.parse(document.getElementById('v2Format').value);
            document.getElementById('v2Format').value = JSON.stringify(sampleV2, null, 2);
        });
    </script>
</body>
</html>